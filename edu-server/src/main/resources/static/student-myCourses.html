<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>我的选课管理 - EduPlatform</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#165DFF',
                        secondary: '#36CFC9',
                        accent: '#722ED1',
                        success: '#52C41A',
                        warning: '#FAAD14',
                        danger: '#FF4D4F',
                        dark: '#1D2129',
                        light: '#F2F3F5'
                    },
                    fontFamily: {
                        inter: ['Inter', 'system-ui', 'sans-serif'],
                    },
                },
            }
        }
    </script>
</head>
<body class="bg-gray-50 font-sans">
<!-- 顶部导航栏（与平台统一） -->
<header class="bg-white shadow-sm sticky top-0 z-50">
    <div class="container mx-auto px-4 py-3 flex justify-between items-center">
        <div class="flex items-center space-x-2">
            <<i class="fa-solid fa-graduation-cap text-primary text-xl"></i>
            <span class="font-bold text-lg text-gray-800">EduPlatform</span>
        </div>

        <!-- 学生用户菜单 -->
        <div class="flex items-center space-x-4">
            <a href="index.html" class="text-gray-600 text-sm hover:text-primary">返回首页</a>
        </div>
    </div>
</header>

<!-- 课程管理主体 -->
<main class="container mx-auto px-4 py-8">
    <!-- 页面标题 -->
    <div class="text-center mb-8">
        <h1 class="text-[clamp(1.8rem,3vw,2.5rem)] font-bold text-gray-800">我的选课</h1>
    </div>

    <!-- 1. 筛选按钮区域：放在课程列表上方，优先展示 -->
    <div class="filter-buttons mb-6 flex gap-3">
        <button onclick="filterCourses('all')" class="active px-4 py-2 bg-blue-500 text-white rounded">全部课程</button>
        <button onclick="filterCourses('ongoing')" class="px-4 py-2 bg-gray-200 rounded hover:bg-gray-300">进行中</button>
        <button onclick="filterCourses('ended')" class="px-4 py-2 bg-gray-200 rounded hover:bg-gray-300">已结束</button>
    </div>
    <!-- 课程列表容器 -->
    <div id="courseList" class="space-y-6">
        <!-- 加载状态 -->
        <div class="flex justify-center py-16">
            <div class="text-center">
                <i class="fa fa-spinner fa-spin text-primary text-3xl mb-4"></i>
                <p class="text-gray-600">加载课程数据中...</p>
            </div>
        </div>
    </div>

    <!-- 分页容器 -->
    <div id="paginationContainer" class="mt-10 flex justify-center hidden">
        <nav class="inline-flex rounded-md shadow" id="pagination">
            <!-- 分页内容将由JS动态生成 -->
        </nav>
    </div>

</main>

<!-- 底部 -->
<footer class="bg-gray-800 text-white py-8 mt-12">
    <div class="container mx-auto px-4 text-center text-gray-400 text-sm">
        <p>© 2025 EduPlatform 教育平台 版权所有</p>
    </div>
</footer>

<!-- 菜单交互JS -->
<script>

    // 假设所有课程数据存在 allCourses 数组中
    let allCourses = []; // 从后端获取的完整课程列表

    // 筛选函数
    function filterCourses(type) {
        let filteredCourses;
        const now = new Date(); // 当前时间
        // 切换按钮激活状态
        const buttons = document.querySelectorAll('.filter-buttons button');
        buttons.forEach(btn => {
            // 移除所有按钮的激活样式
            btn.classList.remove('bg-blue-500', 'text-white');
            btn.classList.add('bg-gray-200');
        });
        // 给当前点击的按钮添加激活样式
        const activeBtn = document.querySelector(`button[onclick="filterCourses('${type}')"]`);
        if (activeBtn) {
            activeBtn.classList.remove('bg-gray-200');
            activeBtn.classList.add('bg-blue-500', 'text-white');
        }
        switch (type) {
            case 'all':
                // 全部课程：显示所有
                filteredCourses = allCourses;
                break;
            case 'ongoing':
                // 进行中：当前时间在课程起止时间之间
                filteredCourses = allCourses.filter(allCourses => {
                    const start = new Date(allCourses.startTime);
                    const end = new Date(allCourses.endTime);
                    return start <= now && now <= end;
                });
                break;
            case 'ended':
                // 已结束：当前时间晚于课程结束时间
                filteredCourses = allCourses.filter(allCourses => {
                    const end = new Date(allCourses.endTime);
                    return now > end;
                });
                break;
            default:
                filteredCourses = allCourses;
        }

        // 筛选后重新渲染课程卡片
        renderCourses(filteredCourses);
    }

    // 获取已选课程列表
    async function fetchStudentmyCourses() {
        try {
            const response = await fetch('api/student/course', {
                method: 'GET',
                headers: {
                    'Authorization': 'Bearer ' + localStorage.getItem('token'),
                    'Content-Type': 'application/json'
                }
            });

            const result = await response.json();

            if (response.ok && result.code === 200) {
                // 成功获取课程列表，处理数据
                const pageresult = result.data;
                const courses = pageresult.records || [];
                allCourses = courses;
               filterCourses();
            } else {
                console.error('获取课程失败:', result.msg);
                alert('获取课程失败: ' + (result.msg || '未知错误'));
            }
        } catch (error) {
            console.error('获取课程时发生网络错误:', error);
            alert('网络错误，无法获取课程列表');
        }
    }

    // 页面加载时获取课程列表
    window.addEventListener('DOMContentLoaded', function() {
        fetchStudentmyCourses();
    });


    // 渲染课程列表到页面
    function renderCourses(courses) {
        const courseContainer = document.getElementById('courseList');
        if (!courseContainer) {
            console.error('未找到课程列表容器');
            return;
        }

        // 清空容器
        courseContainer.innerHTML = '';

        if (courses.length === 0) {
            courseContainer.innerHTML = `
            <div class="text-center py-10">
                <p class="text-gray-500">暂无课程数据，请先创建课程</p>
            </div>
        `;
            return;
        }
        // 遍历课程数据，生成HTML
        courses.forEach(course => {
            // 格式化日期显示
            const formatDate = (dateStr) => {
                if (!dateStr) return '无';
                const date = new Date(dateStr);
                return date.toLocaleDateString('zh-CN', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit'
                });
            };

            const courseCard = document.createElement('div');
            courseCard.className = 'bg-white rounded-xl overflow-hidden shadow-sm hover:shadow-md transition-shadow card-hover border border-gray-100';
// 对应 SQL 字段：ec.id、ec.title、ec.cover、ec.price、ec.status、et.real_name(teacherName)、edu.enroll_time(enrollTime)
            courseCard.innerHTML = `
    <div class="relative">
        <img src="${course.cover || 'default-course.jpg'}" alt="${course.title}" class="w-full h-48 object-cover rounded-t-lg">
        ${course.status === 1 ?
                '<div class="absolute top-3 right-3 bg-green-500 text-white text-xs px-2 py-1 rounded">已选课</div>' :
                '<div class="absolute top-3 right-3 bg-gray-500 text-white text-xs px-2 py-1 rounded">已退课</div>'
            }
    </div>
    <div class="p-5">
        <div class="flex items-center text-sm text-gray-500 mb-2 flex-wrap">
            <span class="bg-blue-50 text-blue-600 px-2 py-0.5 rounded mr-2 mb-1">课程ID: ${course.id}</span>
            <span class="bg-gray-50 text-gray-600 px-2 py-0.5 rounded mb-1">讲师ID: ${course.teacherId || '未指定'}</span>
        </div>
        <h3 class="font-semibold text-lg mb-2 line-clamp-1">${course.title || '无标题'}</h3>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-2 text-sm text-gray-600 mb-4">
            <div>
                <span class="text-gray-500">课程价格:</span> ¥${course.price ? parseFloat(course.price).toFixed(2) : '0.00'}
            </div>
        </div>
        <div class="flex items-center justify-between flex-wrap gap-3">
            <div class="font-bold text-blue-600 text-lg">¥${course.price ? parseFloat(course.price).toFixed(2) : '0.00'}</div>
            <div class="flex space-x-2">
                <button onclick="watchvideo(${course.id})" class="px-3 py-1 bg-red-50 text-red-600 rounded text-sm hover:bg-red-100 transition">观看</button>
                <button onclick="deleteCourse(${course.id})" class="px-3 py-1 bg-red-50 text-red-600 rounded text-sm hover:bg-red-100 transition">删除</button>
            </div>
        </div>
    </div>
`;
            courseContainer.appendChild(courseCard);
        });
    }

    // 退课
    async function deleteCourse(courseId) {
        if (confirm('确定要删除这门课程吗？删除后不可恢复！')) {
            try {
                const response = await fetch(`/api/student/enroll/${courseId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': 'Bearer ' + localStorage.getItem('token'),
                        'Content-Type': 'application/json'
                    }
                });

                const result = await response.json();
                if (response.ok && result.code === 200) {
                    alert('课程退除成功');
                    fetchStudentmyCourses(); // 重新加载课程列表
                } else {
                    alert('退除失败: ' + (result.msg || '未知错误'));
                }
            } catch (error) {
                console.error('退除课程错误:', error);
                alert('网络错误，退除失败');
            }
        }
    }


    // 页面加载时获取课程列表
    window.addEventListener('DOMContentLoaded', function() {
        fetchStudentmyCourses();
    });
    // 模拟获学生课程数据
    window.addEventListener('DOMContentLoaded', function() {
        // 实际项目中这里会通过API获取数据并渲染
        console.log('加载学生课程数据...');
    });

</script>
</body>
</html>